@model GameLoggd.Models.Blackjack.BlackjackGame

@{
    ViewData["Title"] = "Blackjack";
}

<div class="w-full min-h-screen pt-24 pb-12 px-4 flex flex-col items-center justify-center">
    
    <!-- Game Logo -->
    <div class="mb-8 text-center space-y-2 animate-slide-in-up">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-accent-purple/20 border border-accent-purple/50 text-4xl mb-4 shadow-[0_0_30px_rgba(168,85,247,0.3)]">
            ♠️
        </div>
        <h1 class="text-4xl md:text-5xl font-black font-display text-white tracking-tighter uppercase drop-shadow-[0_0_15px_rgba(168,85,247,0.5)]">
            Blackjack
        </h1>
        <p class="text-accent-purple/70 font-mono text-sm tracking-widest uppercase">Beat the Dealer • Pays 3:2</p>
    </div>

    <!-- Game Table -->
    <div class="w-full max-w-4xl bg-[#050505] border border-accent-purple/30 rounded-3xl p-4 md:p-8 relative overflow-hidden shadow-[0_0_50px_rgba(168,85,247,0.15)] flex flex-col justify-between min-h-[600px]">

        <!-- Credits HUD -->
        <div class="absolute top-4 right-4 z-20 px-4 py-2 bg-black/50 border border-white/10 rounded-lg backdrop-blur">
            <div class="text-[0.6rem] font-bold uppercase text-white/30 tracking-wider">Credits</div>
            <div class="font-mono font-bold text-primary text-lg" id="credits-display">@ViewBag.Credits</div>
        </div>
        
        <!-- Background Decorations -->
        <div class="absolute inset-0 opacity-20 pointer-events-none" style="background-image: radial-gradient(circle at 50% 50%, rgba(168,85,247,0.1) 0%, transparent 50%);"></div>
        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-accent-purple to-transparent opacity-50"></div>

        <!-- Dealer Area -->
        <div class="text-center relative z-10 space-y-4">
            <div class="inline-flex items-center gap-2 px-4 py-1 rounded-full bg-accent-purple/10 border border-accent-purple/20 text-accent-purple text-xs font-bold uppercase tracking-widest">
                Dealer
            </div>
            
            <div class="flex justify-center gap-4 min-h-[160px] perspective-[1000px]" id="dealer-cards">
                <!-- Dealer Cards Injected Here -->
            </div>

            <div class="inline-block">
                <div class="px-4 py-1 rounded bg-black border border-white/10 text-white font-mono font-bold text-lg min-w-[3rem]" id="dealer-score">0</div>
            </div>
        </div>

        <!-- Message Overlay -->
        <div class="absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-md hidden" id="game-message">
            <div class="text-center space-y-6 animate-zoom-in">
                <h2 class="text-5xl md:text-7xl font-black font-display text-white tracking-tighter italic drop-shadow-[0_0_30px_rgba(255,255,255,0.4)]" id="result-text">
                    YOU WIN!
                </h2>
                <div class="pt-4">
                    <button class="px-8 py-4 bg-primary text-black font-black uppercase tracking-widest rounded-xl hover:scale-105 hover:shadow-[0_0_30px_rgba(13,242,51,0.4)] transition-all flex items-center gap-2 mx-auto" onclick="startGame()">
                        <span class="material-symbols-outlined">replay</span>
                        Play Again
                    </button>
                </div>
            </div>
        </div>

        <!-- Player Area -->
        <div class="text-center relative z-10 space-y-4 mt-auto">
            <div class="inline-block">
                <div class="px-4 py-1 rounded bg-black border border-white/10 text-white font-mono font-bold text-lg min-w-[3rem]" id="player-score">0</div>
            </div>

            <div class="flex justify-center gap-4 min-h-[160px] perspective-[1000px]" id="player-cards">
                <!-- Player Cards Injected Here -->
            </div>

            <div class="inline-flex items-center gap-2 px-4 py-1 rounded-full bg-accent-cyan/10 border border-accent-cyan/20 text-accent-cyan text-xs font-bold uppercase tracking-widest">
                You
            </div>

            <!-- Controls -->
            <div class="h-20 flex items-center justify-center">
                
                <!-- In-Game Controls -->
                <div id="game-controls" class="hidden flex gap-4">
                    <button class="px-8 py-3 bg-transparent border-2 border-yellow-400 text-yellow-400 font-bold uppercase tracking-widest rounded-xl hover:bg-yellow-400 hover:text-black hover:shadow-[0_0_20px_rgba(250,204,21,0.4)] transition-all transform active:scale-95" onclick="hit()">
                        Hit
                    </button>
                    <button class="px-8 py-3 bg-transparent border-2 border-red-500 text-red-500 font-bold uppercase tracking-widest rounded-xl hover:bg-red-500 hover:text-white hover:shadow-[0_0_20px_rgba(239,68,68,0.4)] transition-all transform active:scale-95" onclick="stand()">
                        Stand
                    </button>
                </div>

                <!-- Start Controls -->
                <div id="start-controls">
                    <button class="px-12 py-4 bg-accent-cyan text-black font-black uppercase tracking-widest rounded-xl hover:bg-white hover:scale-105 hover:shadow-[0_0_30px_rgba(34,211,238,0.4)] transition-all flex items-center gap-2" onclick="startGame()">
                        <span class="material-symbols-outlined">playing_cards</span>
                        Deal Cards
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let prevPlayerCardCount = 0;
        let prevDealerCardCount = 0;

        function getCardSignature(card) {
            if (card.isHidden) return 'hidden';
            return `${card.rank}-${card.suit}`;
        }

        function createCardHtml(card, index, animationType) {
            // animationType: 'deal' | 'flip' | 'none'
            let animClass = '';
            let style = '';
            
            if (animationType === 'deal') {
                animClass = 'animate-slide-in-right opacity-0'; // Add opacity-0 start for keyframe
                style = `animation-delay: ${index * 150}ms; animation-fill-mode: forwards;`;
            } else if (animationType === 'flip') {
                animClass = 'animate-flip-in-y';
            }

            const cardSig = getCardSignature(card);

            if (card.isHidden) {
                return `<div class="w-24 h-36 md:w-28 md:h-40 bg-[#1a1a1a] rounded-xl border-2 border-white/10 flex items-center justify-center shadow-xl relative overflow-hidden ${animClass}" style="${style}" data-card-sig="${cardSig}">
                            <div class="absolute inset-0 bg-[linear-gradient(45deg,transparent_25%,rgba(255,255,255,0.05)_50%,transparent_75%)] bg-[length:250%_250%] animate-pulse"></div>
                            <div class="text-4xl text-white/20 font-display">?</div>
                        </div>`;
            }

            const isRed = card.suit === 0 || card.suit === 1; 
            const colorClass = isRed ? 'text-red-500 border-red-500/30' : 'text-accent-cyan border-accent-cyan/30';
            const shadowClass = isRed ? 'shadow-[0_0_15px_rgba(239,68,68,0.15)]' : 'shadow-[0_0_15px_rgba(34,211,238,0.15)]';
            
            const suits = ['♥', '♦', '♣', '♠'];
            const suitSymbol = suits[card.suit];
            
            let rankStr = card.rank;
            if (card.rank === 11) rankStr = 'J';
            else if (card.rank === 12) rankStr = 'Q';
            else if (card.rank === 13) rankStr = 'K';
            else if (card.rank === 14) rankStr = 'A';

            return `<div class="w-24 h-36 md:w-28 md:h-40 bg-[#151515] rounded-xl border-2 flex flex-col items-center justify-center relative ${colorClass} ${shadowClass} ${animClass} transform hover:-translate-y-2 transition-transform duration-300" style="${style}" data-card-sig="${cardSig}">
                        <div class="absolute top-2 left-2 flex flex-col items-center text-sm font-bold leading-none">
                            <span>${rankStr}</span>
                            <span>${suitSymbol}</span>
                        </div>
                        <div class="text-5xl drop-shadow-md">${suitSymbol}</div>
                        <div class="absolute bottom-2 right-2 flex flex-col items-center text-sm font-bold leading-none rotate-180">
                            <span>${rankStr}</span>
                            <span>${suitSymbol}</span>
                        </div>
                    </div>`;
        }

        function renderHand(containerId, cards) {
            const container = document.getElementById(containerId);
            
            // 1. Remove excess
            while (container.children.length > cards.length) {
                container.removeChild(container.lastChild);
            }

            // 2. Update or Append
            cards.forEach((card, index) => {
                const el = container.children[index];
                const newSig = getCardSignature(card);
                
                if (!el) {
                    // New Card -> Append with Deal animation
                    const temp = document.createElement('div');
                    temp.innerHTML = createCardHtml(card, index, 'deal');
                    container.appendChild(temp.firstElementChild);
                } else {
                    const currentSig = el.getAttribute('data-card-sig');
                    if (currentSig !== newSig) {
                        // Changed Card (e.g. Flip) -> Replace with Flip animation
                        const temp = document.createElement('div');
                        temp.innerHTML = createCardHtml(card, index, 'flip');
                        container.replaceChild(temp.firstElementChild, el);
                    }
                    // Else: Same card, do nothing (preserves DOM/animations state)
                }
            });
        }

        function updateBoard(gameState) {
            renderHand('dealer-cards', gameState.dealerHand.cards);
            renderHand('player-cards', gameState.playerHand.cards);

            document.getElementById('dealer-score').innerText = gameState.dealerHand.score;
            document.getElementById('player-score').innerText = gameState.playerHand.score;

            const creditsEl = document.getElementById('credits-display');
            if (creditsEl && typeof gameState.credits === 'number') {
                creditsEl.innerText = gameState.credits;
            }

            const msgOverlay = document.getElementById('game-message');
            if (gameState.isGameOver) {
                // Smooth fade out of controls
                document.getElementById('game-controls').classList.add('hidden');
                document.getElementById('start-controls').classList.add('hidden');
                
                setTimeout(() => {
                    document.getElementById('result-text').innerText = gameState.message;
                    msgOverlay.classList.remove('hidden');
                    msgOverlay.classList.add('flex');
                }, 1500);
            } else {
                document.getElementById('game-controls').classList.remove('hidden');
                document.getElementById('start-controls').classList.add('hidden');
                msgOverlay.classList.add('hidden');
                msgOverlay.classList.remove('flex');
            }
        }

        async function startGame() {
            // Clear board visuals first for a clean new deal feeling? 
            // Or let renderHand handle it (it will remove excess). 
            // Usually simpler to just clear for a fresh "Deal" animation sequence.
            document.getElementById('dealer-cards').innerHTML = '';
            document.getElementById('player-cards').innerHTML = '';
            
            try {
                const response = await fetch('/blackjack/start', { 
                    method: 'POST',
                    headers: { 'RequestVerificationToken': document.getElementsByName('__RequestVerificationToken')[0]?.value }
                });
                const data = await response.json();
                updateBoard(data);
            } catch (err) { console.error(err); }
        }

        async function hit() {
            try {
                const response = await fetch('/blackjack/hit', { 
                    method: 'POST',
                    headers: { 'RequestVerificationToken': document.getElementsByName('__RequestVerificationToken')[0]?.value }
                });
                const data = await response.json();
                updateBoard(data);
            } catch (err) { console.error(err); }
        }

        async function stand() {
            try {
                 const response = await fetch('/blackjack/stand', { 
                    method: 'POST',
                    headers: { 'RequestVerificationToken': document.getElementsByName('__RequestVerificationToken')[0]?.value }
                });
                const data = await response.json();
                updateBoard(data);
            } catch (err) { console.error(err); }
        }
    </script>
}
