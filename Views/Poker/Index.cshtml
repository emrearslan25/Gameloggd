@model GameLoggd.Models.Poker.PokerGame

@{
    ViewData["Title"] = "Video Poker";
}

<div class="w-full min-h-screen pt-24 pb-12 px-4 flex flex-col items-center">
    
    <!-- Game Logo -->
    <div class="mb-8 text-center space-y-2 animate-slide-in-up">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-accent-cyan/20 border border-accent-cyan/50 text-4xl mb-4 shadow-[0_0_30px_rgba(34,211,238,0.3)]">
            ♦️
        </div>
        <h1 class="text-4xl md:text-5xl font-black font-display text-white tracking-tighter uppercase drop-shadow-[0_0_15px_rgba(34,211,238,0.5)]">
            Video Poker
        </h1>
    </div>

    <!-- Game Table -->
    <div class="w-full max-w-5xl bg-[#050505] border border-accent-cyan/30 rounded-3xl p-4 md:p-8 relative overflow-hidden shadow-[0_0_50px_rgba(34,211,238,0.15)] flex flex-col min-h-[600px]">
        
        <!-- Background Decorations -->
        <div class="absolute inset-0 opacity-20 pointer-events-none" style="background-image: radial-gradient(circle at 50% 50%, rgba(34,211,238,0.1) 0%, transparent 50%);"></div>
        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-accent-cyan to-transparent opacity-50"></div>

        <!-- Paytable -->
        <div class="grid grid-cols-3 md:grid-cols-5 lg:grid-cols-9 gap-2 mb-8 p-4 bg-white/5 rounded-xl border border-white/10 text-[0.6rem] md:text-xs">
            <div class="flex flex-col items-center p-2 rounded hover:bg-white/5 transition-colors"><span class="text-accent-purple font-black">ROYAL FLUSH</span><span class="text-white font-mono">800</span></div>
            <div class="flex flex-col items-center p-2 rounded hover:bg-white/5 transition-colors"><span class="text-accent-purple font-black">STR. FLUSH</span><span class="text-white font-mono">50</span></div>
            <div class="flex flex-col items-center p-2 rounded hover:bg-white/5 transition-colors"><span class="text-accent-purple font-black">4 OF A KIND</span><span class="text-white font-mono">25</span></div>
            <div class="flex flex-col items-center p-2 rounded hover:bg-white/5 transition-colors"><span class="text-accent-purple font-black">FULL HOUSE</span><span class="text-white font-mono">9</span></div>
            <div class="flex flex-col items-center p-2 rounded hover:bg-white/5 transition-colors"><span class="text-accent-purple font-black">FLUSH</span><span class="text-white font-mono">6</span></div>
            <div class="flex flex-col items-center p-2 rounded hover:bg-white/5 transition-colors"><span class="text-accent-purple font-black">STRAIGHT</span><span class="text-white font-mono">4</span></div>
            <div class="flex flex-col items-center p-2 rounded hover:bg-white/5 transition-colors"><span class="text-accent-purple font-black">3 OF A KIND</span><span class="text-white font-mono">3</span></div>
            <div class="flex flex-col items-center p-2 rounded hover:bg-white/5 transition-colors"><span class="text-accent-purple font-black">TWO PAIR</span><span class="text-white font-mono">2</span></div>
            <div class="flex flex-col items-center p-2 rounded hover:bg-white/5 transition-colors"><span class="text-accent-purple font-black">JACKS+</span><span class="text-white font-mono">1</span></div>
        </div>

        <!-- Message Overlay -->
        <div class="absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-md hidden" id="game-message-overlay">
            <div class="text-center space-y-6 animate-zoom-in">
                <h2 class="text-5xl md:text-7xl font-black font-display text-white tracking-tighter italic drop-shadow-[0_0_30px_rgba(255,255,255,0.4)]" id="result-text">
                    WINNER!
                </h2>
                <div class="pt-4">
                    <button class="px-8 py-4 bg-accent-cyan text-black font-black uppercase tracking-widest rounded-xl hover:bg-white hover:scale-105 hover:shadow-[0_0_30px_rgba(34,211,238,0.4)] transition-all flex items-center gap-2 mx-auto" onclick="closeOverlay()">
                        Continue
                        <span class="material-symbols-outlined">arrow_forward</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Cards Area -->
        <div class="flex-1 flex items-center justify-center my-8">
            <div class="flex justify-center gap-2 md:gap-4 perspective-[1000px]" id="cards-area">
                @for(int i=0; i<5; i++) {
                    <div class="flex flex-col items-center gap-4 cursor-pointer group transition-all duration-300" id="card-container-@i" onclick="toggleHold(@i)">
                        <div id="card-@i" class="w-20 h-28 md:w-32 md:h-44 bg-[#1a1a1a] rounded-xl border-2 border-white/10 flex items-center justify-center shadow-xl relative overflow-hidden group-hover:border-white/30 transition-all">
                             <div class="text-4xl text-white/20 font-display">?</div>
                        </div>
                        <div class="px-3 py-1 rounded-full bg-black border border-white/10 text-[0.6rem] font-bold uppercase tracking-widest text-white/30 transition-all" id="badge-@i">Hold</div>
                    </div>
                }
            </div>
        </div>

        <!-- Bottom Controls -->
        <div class="mt-auto bg-black/40 border-t border-white/10 p-4 md:p-6 rounded-b-3xl -mx-4 -mb-4 md:-mx-8 md:-mb-8 flex flex-col md:flex-row items-center justify-between gap-4">
            
            <!-- Bet Controls -->
            <div class="flex items-center gap-4 bg-white/5 px-4 py-2 rounded-xl border border-white/5">
                <span class="text-xs font-bold uppercase text-white/50 tracking-wider">Bet</span>
                <div class="flex items-center gap-2">
                    <button class="w-8 h-8 rounded-lg bg-black/50 border border-white/10 hover:border-white/30 text-white flex items-center justify-center transition-colors" onclick="changeBet(-1)">-</button>
                    <span class="text-xl font-mono font-bold text-accent-cyan w-8 text-center" id="bet-display">1</span>
                    <button class="w-8 h-8 rounded-lg bg-black/50 border border-white/10 hover:border-white/30 text-white flex items-center justify-center transition-colors" onclick="changeBet(1)">+</button>
                </div>
            </div>

            <!-- Credits -->
            <div class="flex flex-col items-center">
                <span class="text-[0.6rem] font-bold uppercase text-white/30 tracking-[0.2em]">Credits</span>
                <span class="text-2xl font-mono font-bold text-primary drop-shadow-[0_0_10px_rgba(13,242,51,0.3)] min-w-[3rem] text-center" id="credits-display">@Model.Credits</span>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-4">
                <button class="px-8 py-3 bg-accent-cyan text-black font-black uppercase tracking-widest rounded-xl hover:bg-white hover:scale-105 hover:shadow-[0_0_30px_rgba(34,211,238,0.4)] transition-all min-w-[140px]" id="btn-deal" onclick="deal()">
                    Deal
                </button>
                <button class="px-8 py-3 bg-accent-purple text-white font-black uppercase tracking-widest rounded-xl hover:bg-white hover:text-black hover:scale-105 hover:shadow-[0_0_30px_rgba(168,85,247,0.4)] transition-all hidden min-w-[140px]" id="btn-draw" onclick="draw()">
                    Draw
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentBet = 1;
        let heldCards = [false, false, false, false, false];
        let canDraw = false;

        function changeBet(delta) {
            if (canDraw) return;
            currentBet += delta;
            if (currentBet < 1) currentBet = 1;
            if (currentBet > 5) currentBet = 5;
            document.getElementById('bet-display').innerText = currentBet;
        }

        function toggleHold(index) {
            if (!canDraw) return;
            heldCards[index] = !heldCards[index];
            updateHoldUI(index);
        }

        function updateHoldUI(index) {
            const container = document.getElementById(`card-container-${index}`);
            const badge = document.getElementById(`badge-${index}`);
            const card = document.getElementById(`card-${index}`);

            if (heldCards[index]) {
                // Active Hold State
                badge.classList.remove('bg-black', 'border-white/10', 'text-white/30');
                badge.classList.add('bg-yellow-400', 'border-yellow-400', 'text-black', 'shadow-[0_0_15px_rgba(250,204,21,0.4)]');
                
                card.classList.add('border-yellow-400', 'shadow-[0_0_20px_rgba(250,204,21,0.2)]', '-translate-y-2');
                card.classList.remove('border-white/10');
            } else {
                // Inactive State
                badge.classList.add('bg-black', 'border-white/10', 'text-white/30');
                badge.classList.remove('bg-yellow-400', 'border-yellow-400', 'text-black', 'shadow-[0_0_15px_rgba(250,204,21,0.4)]');
                
                card.classList.remove('border-yellow-400', 'shadow-[0_0_20px_rgba(250,204,21,0.2)]', '-translate-y-2');
                card.classList.add('border-white/10');
            }
        }

        function createCardHtml(card, index, isNew) {
            const animationClass = isNew ? 'animate-flip-in-y' : '';
            const styleDelay = isNew ? `animation-delay: ${index * 100}ms; animation-fill-mode: backwards;` : '';

            if (!card || card.suit === undefined) {
                 return `<div id="card-${index}" class="w-20 h-28 md:w-32 md:h-44 bg-[#1a1a1a] rounded-xl border-2 border-white/10 flex items-center justify-center shadow-xl relative overflow-hidden ${animationClass}" style="${styleDelay}">
                             <div class="text-4xl text-white/20 font-display">?</div>
                        </div>`;
            }

            const isRed = card.suit === 0 || card.suit === 1; 
            const colorClass = isRed ? 'text-red-500 border-red-500/30' : 'text-accent-cyan border-accent-cyan/30';
            const shadowClass = isRed ? 'shadow-[0_0_15px_rgba(239,68,68,0.15)]' : 'shadow-[0_0_15px_rgba(34,211,238,0.15)]';
            
            const suits = ['♥', '♦', '♣', '♠'];
            const suitSymbol = suits[card.suit];
            
            let rankStr = card.rank;
            if (card.rank === 11) rankStr = 'J';
            else if (card.rank === 12) rankStr = 'Q';
            else if (card.rank === 13) rankStr = 'K';
            else if (card.rank === 14) rankStr = 'A';

            return `<div id="card-${index}" class="w-20 h-28 md:w-32 md:h-44 bg-[#151515] rounded-xl border-2 flex flex-col items-center justify-center relative ${colorClass} ${shadowClass} ${animationClass}" style="${styleDelay}">
                        <div class="absolute top-2 left-2 flex flex-col items-center text-sm font-bold leading-none">
                            <span>${rankStr}</span>
                            <span>${suitSymbol}</span>
                        </div>
                        <div class="text-5xl drop-shadow-md">${suitSymbol}</div>
                        <div class="absolute bottom-2 right-2 flex flex-col items-center text-sm font-bold leading-none rotate-180">
                            <span>${rankStr}</span>
                            <span>${suitSymbol}</span>
                        </div>
                    </div>`;
        }

        function renderCardUI(index, card, isNew) {
            const oldCard = document.getElementById(`card-${index}`);
            const newHtml = createCardHtml(card, index, isNew);
            
            // Replace the card element (keeping the container wrapper)
            if(oldCard) {
                oldCard.outerHTML = newHtml;
            } else {
                 // Fallback if structure is broken
                 const container = document.getElementById(`card-container-${index}`);
                 container.innerHTML = newHtml + `<div class="px-3 py-1 rounded-full bg-black border border-white/10 text-[0.6rem] font-bold uppercase tracking-widest text-white/30 transition-all" id="badge-${index}">Hold</div>`;
            }
            
            // Maintain hold visual state if drawing
            if (canDraw) updateHoldUI(index);
        }

        async function deal() {
            try {
                heldCards = [false, false, false, false, false];
                for(let i=0; i<5; i++) updateHoldUI(i);

                const response = await fetch('/poker/start', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': document.getElementsByName('__RequestVerificationToken')[0]?.value },
                    body: JSON.stringify(currentBet)
                });
                
                if (!response.ok) {
                    alert(await response.text());
                    return;
                }

                const data = await response.json();
                
                document.getElementById('credits-display').innerText = data.credits;
                data.hand.forEach((c, i) => renderCardUI(i, c, true));
                
                canDraw = true;
                document.getElementById('btn-deal').classList.add('hidden');
                document.getElementById('btn-draw').classList.remove('hidden');

            } catch (err) { console.error(err); }
        }

        async function draw() {
             try {
                const response = await fetch('/poker/draw', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': document.getElementsByName('__RequestVerificationToken')[0]?.value },
                    body: JSON.stringify(heldCards)
                });
                
                const data = await response.json();
                
                document.getElementById('credits-display').innerText = data.credits;
                // Animate only replaced cards
                data.hand.forEach((c, i) => renderCardUI(i, c, !heldCards[i]));
                
                if (data.payout > 0) {
                     setTimeout(() => showOverlay(`WIN: ${data.payout}`), 1000);
                } else {
                     setTimeout(() => showOverlay("GAME OVER"), 1000);
                }

                canDraw = false;
                document.getElementById('btn-deal').classList.remove('hidden');
                document.getElementById('btn-draw').classList.add('hidden');
                
                // Clear hold UI
                heldCards = [false, false, false, false, false];
                for(let i=0; i<5; i++) {
                     const badge = document.getElementById(`badge-${i}`);
                     badge.classList.add('bg-black', 'border-white/10', 'text-white/30');
                     badge.classList.remove('bg-yellow-400', 'border-yellow-400', 'text-black', 'shadow-[0_0_15px_rgba(250,204,21,0.4)]');
                }

            } catch (err) { console.error(err); }
        }

        function showOverlay(msg) {
            const ol = document.getElementById('game-message-overlay');
            document.getElementById('result-text').innerText = msg;
            ol.classList.remove('hidden');
            ol.classList.add('flex');
        }

        function closeOverlay() {
            const ol = document.getElementById('game-message-overlay');
            ol.classList.add('hidden');
            ol.classList.remove('flex');
        }
    </script>
}
