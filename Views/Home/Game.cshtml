@model GameLoggd.Models.ViewModels.GameDetailViewModel
@{
    ViewData["Title"] = Model.Game.Title;
}

<div class="detail-hero">
    <div class="detail-hero-bg">
        @if (!string.IsNullOrEmpty(Model.Game.ImagePath))
        {
            <img src="@Model.Game.ImagePath" alt="@Model.Game.Title"/>
        }
    </div>
    <div class="detail-hero-overlay"></div>
    <div class="detail-hero-content">
        <div class="page-container" style="width: 100%;">
            <div class="detail-grid">
                <div class="detail-poster">
                    @if (!string.IsNullOrEmpty(Model.Game.ImagePath))
                    {
                        <img src="@Model.Game.ImagePath" alt="@Model.Game.Title" />
                    }
                    else
                    {
                        <div style="width:100%; height: 380px; background: #222; display: flex; align-items:center; justify-content:center; color: #555;">No Image</div>
                    }
                </div>
                <div class="detail-info">
                    <h1 style="text-shadow: 0 2px 4px rgba(0,0,0,0.8);">@Model.Game.Title</h1>
                    <div class="detail-meta">
                        <span>@(Model.Game.Year?.ToString() ?? "—")</span>
                        <span class="dot">•</span>
                        <span>@(string.IsNullOrWhiteSpace(Model.Game.Developer) ? "Unknown Dev" : Model.Game.Developer)</span>
                    </div>

                    <div class="detail-rating">
                        <div class="stars">
                            @{
                                var avg = Model.AverageRating;
                                var full = (int)Math.Floor(avg);
                                var half = (avg - full) >= 0.5;
                                var empty = 5 - full - (half ? 1 : 0);
                            }
                            @for (int i = 0; i < full; i++) { <span class="star filled">★</span> }
                            @if(half) { <span class="star half">★</span> }
                            @for (int i = 0; i < empty; i++) { <span class="star">★</span> }
                        </div>
                        <span class="rating-number">@Model.AverageRating.ToString("0.0")</span>
                        <span class="rating-count">(@Model.Reviews.Count reviews)</span>
                    </div>

                    <div class="detail-description" style="margin-bottom: 2rem; max-width: 40rem; line-height: 1.6; color: #e0e0e0; text-shadow: 0 1px 2px rgba(0,0,0,0.8);">
                        @Model.Game.Description
                    </div>

                    <div class="detail-actions">
                        @if (User.Identity.IsAuthenticated)
                        {
                            <!-- Log Button Dropdown Logic (Simplified as form buttons for now) -->
                            <form method="post" action="/game/@Model.Game.Slug/log" style="display:inline;">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="status" value="Played" />
                                <button type="submit" class="btn-primary" style="@(Model.CurrentUserStatus?.Status == GameLoggd.Models.Domain.GameStatus.Played ? "box-shadow: 0 0 15px var(--neon-cyan);" : "")">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M20 6L9 17l-5-5"></path>
                                    </svg>
                                    @(Model.CurrentUserStatus?.Status == GameLoggd.Models.Domain.GameStatus.Played ? "Played" : "Log as Played")
                                </button>
                            </form>

                            <form method="post" action="/game/@Model.Game.Slug/log" style="display:inline;">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="status" value="Backlog" />
                                <button type="submit" class="btn-secondary" style="@(Model.CurrentUserStatus?.Status == GameLoggd.Models.Domain.GameStatus.Backlog ? "border-color: var(--neon-cyan); color: var(--neon-cyan);" : "")">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 5v14M5 12h14"></path>
                                    </svg>
                                    @(Model.CurrentUserStatus?.Status == GameLoggd.Models.Domain.GameStatus.Backlog ? "In Backlog" : "Add to Backlog")
                                </button>
                            </form>
                            
                             <form method="post" action="/game/@Model.Game.Slug/log" style="display:inline;">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="status" value="Playing" />
                                <button type="submit" class="btn-secondary" style="@(Model.CurrentUserStatus?.Status == GameLoggd.Models.Domain.GameStatus.Playing ? "border-color: var(--neon-purple); color: var(--neon-purple);" : "")">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                                        <path d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    @(Model.CurrentUserStatus?.Status == GameLoggd.Models.Domain.GameStatus.Playing ? "Playing" : "Playing")
                                </button>
                            </form>
                        }
                        else 
                        {
                            <a href="/account" class="btn-primary">Login to Log</a>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="page-container" style="padding-top: 3rem; padding-bottom: 3rem;">
    <div class="detail-grid">
        <div class="sidebar">

            <h3 style="color: #888; margin-bottom: 1rem; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.1em;">Platforms</h3>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 2rem;">
                @foreach(var p in Model.Game.Platforms)
                {
                    <span style="padding: 0.4rem 0.8rem; background: #222; border-radius: 4px; font-size: 0.85rem; border: 1px solid #333;">
                        @if(!string.IsNullOrEmpty(p.IconClass))
                        {
                            <i class="@p.IconClass" style="margin-right:0.3rem;"></i>
                        }
                        @p.Name
                    </span>
                }
                @if(!Model.Game.Platforms.Any()) { <span style="color:#555;">No platforms info</span> }
            </div>

            <h3 style="color: #888; margin-bottom: 1rem; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.1em;">Genres</h3>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                @foreach(var g in Model.Game.Genres)
                {
                    <span style="padding: 0.4rem 0.8rem; background: #222; border-radius: 4px; font-size: 0.85rem; border: 1px solid #333;">@g.Name</span>
                }
                @if(!Model.Game.Genres.Any()) { <span style="color:#555;">No genre info</span> }
            </div>
        </div>
        
        <div class="main-content">
            <h2 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                Reviews
                <span style="font-size: 1rem; color: #666; font-weight: normal;">@Model.Reviews.Count</span>
            </h2>

            @if (User.Identity.IsAuthenticated)
            {
                <div style="margin-bottom: 2rem;">
                     <!-- Trigger Button -->
                     <button onclick="openRatingModal()" class="btn-primary" style="width: 100%; justify-content: center; padding: 1rem; font-size: 1.1rem;">
                        <span style="font-size: 1.2rem; margin-right: 0.5rem;">★</span> 
                        @(Model.CurrentUserReview != null ? $"Your Rating: {Model.CurrentUserReview.Rating}" : "Rate or Review this Game")
                     </button>
                </div>

                <!-- Rating Modal -->
                <div id="ratingModal" class="modal" style="display:none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(5px);">
                    <div class="modal-content" style="background-color: var(--bg-card); margin: 10% auto; padding: 2rem; border: 1px solid var(--border-color); width: 90%; max-width: 500px; border-radius: 1rem; box-shadow: 0 0 20px rgba(0,0,0,0.5); position: relative;">
                        <span class="close" onclick="closeRatingModal()" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.2s;">&times;</span>
                        <h2 style="margin-bottom: 1.5rem; color: white;">Rate @Model.Game.Title</h2>
                        
                        <form method="post" action="/game/@Model.Game.Slug/review">
                            @Html.AntiForgeryToken()
                            
                            <div class="star-rating" style="margin-bottom: 1.5rem; text-align: center;">
                                <p style="margin-bottom: 0.5rem; color: var(--text-secondary);">Your Rating</p>
                                <div class="stars-input">
                                    @{
                                        double currentRating = Model.CurrentUserReview?.Rating ?? 0;
                                    }
                                    @for (double i = 5; i >= 0.5; i -= 0.5)
                                    {
                                        var isChecked = currentRating == i;
                                        var idStr = "star-" + i.ToString().Replace(".", "-").Replace(",", "-");
                                        <input type="radio" name="rating" value="@i" id="@idStr" @(isChecked ? "checked" : "") style="display: none;" />
                                        <label for="@idStr" class="@((i % 1 != 0) ? "half" : "full")" title="@i"></label>
                                    }
                                </div>
                            </div>
                            
                            <!-- Optional Date Logic (Only if Played) -->
                            <!-- Re-integrating the DatePlayed logic cleanly -->
                            <div class="review-input" style="margin-bottom: 1.5rem;">
                                <label for="playedDate" style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Date Played (Optional)</label>
                                <input type="date" name="datePlayed" id="playedDate" 
                                       value="@(Model.CurrentUserStatus?.DatePlayed?.ToString("yyyy-MM-dd") ?? DateTime.Now.ToString("yyyy-MM-dd"))" 
                                       style="width: 100%; background: #222; border: 1px solid #444; color: #fff; padding: 0.8rem; border-radius: 4px;" />
                            </div>

                            <div class="review-input" style="margin-bottom: 1.5rem;">
                                <label for="review" style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Review (Optional)</label>
                                <textarea name="content" id="review" rows="4" placeholder="What do you think about this game?" 
                                          style="width: 100%; background: #222; border: 1px solid #444; color: #fff; padding: 0.8rem; border-radius: 4px; resize: vertical;">@(Model.CurrentUserReview?.Content)</textarea>
                            </div>
                            
                            <div class="modal-actions" style="display: flex; gap: 1rem; justify-content: flex-end;">
                                @if (Model.CurrentUserReview != null)
                                {
                                    /* Logic for delete would usually go to a separate endpoint or method, 
                                       simulating via a separate form button if needed or js */
                                }
                                <button type="button" class="btn-secondary" onclick="closeRatingModal()">Cancel</button>
                                <button type="submit" class="btn-primary">Save Rating</button>
                            </div>
                        </form>
                    </div>
                </div>
            }
            else 
            {
                 <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; text-align: center; border-radius: 0.75rem; margin-bottom: 2rem; color: var(--text-secondary);">
                    <a href="/account" style="color: var(--neon-cyan); text-decoration: underline;">Login</a> to write a review.
                </div>
            }

            <div class="reviews-list">
                @foreach (var review in Model.Reviews)
                {
                    <div class="review-card">
                        <div class="review-avatar avatar-cyan">
                            @(review.User?.UserName?.Substring(0,1).ToUpper() ?? "?")
                        </div>
                        <div class="review-content">
                             <div class="review-header" style="justify-content: space-between;">
                                <div style="display:flex; gap: 0.5rem; align-items:center;">
                                    <span class="reviewer-name">@review.User?.UserName</span>
                                    <div class="review-stars">
                                        @for(int i=1; i<=5; i++) 
                                        {
                                            if (review.Rating >= i) { <span class="star filled">★</span> }
                                            else if (review.Rating >= i - 0.5) { <span class="star half">★</span> }
                                            else { <span class="star">★</span> }
                                        }
                                    </div>
                                </div>
                                <span class="review-time">@review.CreatedAt.ToString("MMM dd, yyyy")</span>
                            </div>
                            <p class="review-text">@review.Content</p>
                            
                            <div class="review-footer" style="margin-top: 0.5rem; display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                                <form method="post" action="/review/like">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="reviewId" value="@review.Id" />
                                    <button type="submit" style="display: flex; align-items: center; gap: 0.3rem; color: @(review.IsLikedByCurrentUser ? "#ff304f" : "#666"); transition: color 0.2s; background:none; border:none; padding:0; cursor:pointer;">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="@(review.IsLikedByCurrentUser ? "currentColor" : "none")" stroke="currentColor" stroke-width="2">
                                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                        </svg>
                                        <span style="font-size: 0.9rem;">@review.LikeCount</span>
                                    </button>
                                </form>
                            </div>
                            
                            <!-- COMMENTS SECTION -->
                            <div class="review-comments" style="margin-top: 1rem; border-top: 1px solid #333; padding-top: 0.5rem;">
                                @if (review.Comments.Any())
                                {
                                    <div style="margin-bottom: 0.5rem;">
                                        @foreach(var comment in review.Comments)
                                        {
                                            <div style="font-size: 0.85rem; margin-bottom: 0.3rem; color: #ccc;">
                                                <span style="color: var(--neon-cyan); font-weight: bold;">@comment.User?.UserName:</span>
                                                @comment.Content
                                            </div>
                                        }
                                    </div>
                                }

                                @if (User.Identity.IsAuthenticated)
                                {
                                    <form method="post" action="/review/comment" style="display:flex; gap:0.5rem;">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="reviewId" value="@review.Id" />
                                        <input name="content" placeholder="Write a comment..." style="background: #222; border: 1px solid #444; color: #fff; padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.85rem; flex-grow: 1;" required />
                                        <button type="submit" style="background: var(--neon-cyan); border:none; border-radius: 4px; padding: 0 0.8rem; cursor:pointer; font-size: 0.8rem; color:#000; font-weight:bold;">Post</button>
                                    </form>
                                }
                            </div>
                        </div>
                    </div>
                }

                @if(!Model.Reviews.Any())
                {
                    <p style="color: #666; font-style: italic;">No reviews yet. Be the first to review!</p>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function openRatingModal() {
            var modal = document.getElementById('ratingModal');
            if(modal) modal.style.display = 'block';
        }
        
        function closeRatingModal() {
            var modal = document.getElementById('ratingModal');
            if(modal) modal.style.display = 'none';
        }
        
        window.onclick = function(event) {
            var modal = document.getElementById('ratingModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
    </script>
}
